---
title: Issues with tm.plugin.mail
author: Kurt Hornik
margin-left: 3cm
---

CRAN package
[`tm.plugin.mail`](https://CRAN.R-project.org/package=tm.plugin.mail)
has long provided basic infrastructure for working with text in internet
messages ('emails'), with a *source* (`MboxSource()`) for messages
stored in 'mbox format' and a *reader* (`readMail`) , a function
generator which returns a `MailDocument` object representing the text
and metadata extracted from a message.

The package was initially written to facilitate the content-based social
network analyses of the R-devel and R-help mailing lists in
[Bohn, Feinerer, Hornik & Mair (2011)](https://doi.org/10.32614/RJ-2011-003)
which mostly provided all-ASCII plain text messages, perhaps with
attachments which can be removed via `removeMultipart()`.  Hence, the
`MailDocument` objects were taken to extend `PlainTextDocument` with
plain text content only.

This clearly needs revisiting with the increasing use of multipart
messages featuring both plain text and HTML parts, which both could be
considered as 'text'.  The obvious idea is to turn `MailDocument` into
an abstract class, perhaps representing plain text content as such and
multipart content as a list of the parts, along with providing suitable
methods for the generic extractors from CRAN package 
[`NLP`](https://CRAN.R-project.org/package=NLP) which allow selecting
text, HTML or both.

Unfortunately, things are more complicated.  With
[MIME](https://www.rfc-editor.org/rfc/rfc2045), both textual message
bodies and textual header information can use character sets other than
US-ASCII, typically via quoted-printable or base64 encodings.
Currently, there is no support for this.  One needs to add mechanisms
for at least optionally decoding MIME-encoded textual parts.  In the
simplest case, `readMail()` would gain a `decode` argument.

There are also two problems with `MboxSource()`.  First, this currently
has an `encoding` argument used for specifying the encoding of the mbox
for subsequent conversion to UTF-8.  That seems inappropriate: one needs
to process the message headers for correct interpretation of non-ASCII
characters in messages, which should be left to `readMail()`.  It seems
best to have the source use a `bytes` encoding for non-ASCII content.

In addition, the notion of 'MBOX format' is rather ill-defined.  The
basic understanding is that the format uses a single blank line followed
by the string `"From "` (with a space) to delimit messages, which can lead
to ambiguities if a message contains the same sequence in the message
text.  The [Library of Congress MBOX Email Format
page](https://www.loc.gov/preservation/digital/formats/fdd/fdd000383.shtml)
lists four variants of MBOX formats designed to avoid these problems,
with
[MBOXRD](https://www.loc.gov/preservation/digital/formats/fdd/fdd000385.shtml)
nowadays used by Emacs Rmail.  One idea could be to enhance
`MboxSource()` to allow for specifying the format employed.

The Library of Congress page also suggests that the `"From "` lines have
structure
```
  From <sender> <date> <moreinfo>
```
where

* `<sender>`, usually the envelope sender of the message, is one word
  without spaces or tabs

* `<date>` is the delivery date of the message which always contains
  exactly 24 characters in Standard C asctime format (i.e. in English,
  with the redundant weekday, and without timezone information) 

One could at least optionally identity message separating `"From "`
lines using the above specification.  Emacs Rmail supports more legacy
format variants, but we could make the regexp for identifying `"From "`
lines customizable.

To deal with the above issues, it seems best to start with
`MboxSource()`, and in turn run some experiments with the MBOX files
generated by Emacs VM and the mailman system used for the R mailing
lists.
